<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON to PMTiles Converter</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            margin-bottom: 0.5rem;
        }
        a {
            color: #0066cc;
            text-decoration: none;
            
        }
        a:hover {
                text-decoration: underline;
        }
        .subtitle {
            color: #666;
        }
        .warning {
            color: #722424;
            font-size: 0.8rem;
        }
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #0066cc;
            background: #f0f7ff;
        }
        .drop-zone.has-file {
            border-color: #28a745;
            background: #f0fff4;
        }
        .drop-zone input[type="file"] {
            display: none;
        }
        .file-info {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        .options {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .option-row:last-child {
            margin-bottom: 0;
        }
        .option-row label {
            width: 140px;
            font-weight: 500;
        }
        .option-row input, .option-row select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        .option-row input[type="number"] {
            width: 80px;
            flex: none;
        }
        .option-row .hint {
            margin-left: 1rem;
            color: #888;
            font-size: 0.85rem;
        }
        button {
            background: #0066cc;
            color: #fff;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) {
            background: #0052a3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress-container {
            display: none;
            margin-top: 1.5rem;
        }
        .progress-container.active {
            display: block;
        }
        .progress-bar {
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00a8cc);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            display: none;
        }
        .log.active {
            display: block;
        }
        .log .error {
            color: #f48771;
        }
        .result {
            display: none;
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            text-align: center;
        }
        .result.active {
            display: block;
        }
        .result.success {
            border: 2px solid #28a745;
        }
        .result.error {
            border: 2px solid #dc3545;
        }
        .result h3 {
            margin: 0 0 1rem 0;
        }
        .result .stats {
            color: #666;
            margin-bottom: 1rem;
        }
        .download-btn {
            background: #28a745;
            display: inline-block;
            width: auto;
            padding: 0.75rem 2rem;
        }
        .download-btn:hover {
            background: #218838;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GeoJSON to PMTiles</h1>
        <a class="subtitle" href="https://github.com/mchaynes/tippecanoe-wasm" target="_blank">GitHub</a>
    </div>

        <p class="subtitle">Convert GeoJSON to PMTiles in your browser. Uses Tippecanoe compiled to WASM.</p>

    <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept=".geojson,.json">
        <p>Drop a GeoJSON file here or click to browse</p>
        <div class="file-info" id="fileInfo"></div>
    </div>

    <div class="options">
        <div class="option-row">
            <label for="minZoom">Min Zoom</label>
            <input type="number" id="minZoom" value="0" min="0" max="22">
            <span class="hint">Minimum zoom level (0-22)</span>
        </div>
        <div class="option-row">
            <label for="maxZoom">Max Zoom</label>
            <input type="number" id="maxZoom" value="14" min="0" max="22">
            <span class="hint">Maximum zoom level (0-22)</span>
        </div>
        <div class="option-row">
            <label for="layerName">Layer Name</label>
            <input type="text" id="layerName" placeholder="(auto-detect from filename)">
            <span class="hint">Name for the vector tile layer</span>
        </div>
    </div>

    <button id="convertBtn" disabled>Select a GeoJSON file to convert</button>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Initializing...</div>
    </div>

    <div class="log" id="log"></div>

    <div class="result" id="result">
        <h3 id="resultTitle"></h3>
        <p class="subtitle">Upload your PMTIles file to <a href="https://pmtiles.io" target="_blank">pmtiles.io</a> to check that it looks the way you want</p>
        <div class="stats" id="resultStats"></div>
        <button class="download-btn" id="downloadBtn">Download PMTiles</button>
    </div>


    <p class="warning">
        This website is AI slop. I told Claude to compile Tippecanoe to WASM, and this is the result.
    </p>
    <p class="warning">
        Seems to work okay though. YMMV.
    </p>
    <script type="module">
        const { createTippecanoe } = await import('./index.js?v=6');

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const convertBtn = document.getElementById('convertBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logEl = document.getElementById('log');
        const result = document.getElementById('result');
        const resultTitle = document.getElementById('resultTitle');
        const resultStats = document.getElementById('resultStats');
        const downloadBtn = document.getElementById('downloadBtn');

        let selectedFile = null;
        let pmtilesBlob = null;
        let tippecanoe = null;

        // File selection handling
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            selectedFile = file;
            dropZone.classList.add('has-file');
            fileInfo.textContent = `${file.name} (${formatBytes(file.size)})`;
            convertBtn.disabled = false;
            convertBtn.textContent = 'Convert to PMTiles';
            result.classList.remove('active', 'success', 'error');
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function log(message, isError = false) {
            logEl.classList.add('active');
            const line = document.createElement('div');
            if (isError) line.classList.add('error');
            line.textContent = message;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            logEl.innerHTML = '';
            logEl.classList.remove('active');
        }

        // Conversion
        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            clearLog();
            result.classList.remove('active', 'success', 'error');
            progressContainer.classList.add('active');
            progressFill.style.width = '0%';
            progressText.textContent = 'Loading tippecanoe...';
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<span class="loading-spinner"></span>Converting...';

            try {
                // Initialize tippecanoe if needed
                if (!tippecanoe) {
                    log('Initializing Tippecanoe WASM...');
                    tippecanoe = await createTippecanoe({
                        threads: false, // Use single-threaded for broader compatibility
                        onStdout: (text) => log(text),
                        onStderr: (text) => log(text, true),
                    });
                    log('Tippecanoe ready!');
                }

                progressText.textContent = 'Reading GeoJSON file...';
                progressFill.style.width = '10%';

                // Read the file
                const fileData = await selectedFile.arrayBuffer();
                const geojsonBytes = new Uint8Array(fileData);
                log(`Read ${formatBytes(geojsonBytes.length)} of GeoJSON data`);

                progressText.textContent = 'Converting to PMTiles...';
                progressFill.style.width = '20%';

                // Build arguments
                const minZoom = parseInt(document.getElementById('minZoom').value) || 0;
                const maxZoom = parseInt(document.getElementById('maxZoom').value) || 14;
                const layerName = document.getElementById('layerName').value.trim();

                const inputFilename = 'input.geojson';
                const outputFilename = 'output.pmtiles';

                const args = [
                    '-o', outputFilename,
                    '-z', maxZoom.toString(),
                    '-Z', minZoom.toString(),
                    '--force',
                    '--no-progress-indicator',
                ];

                if (layerName) {
                    args.push('-l', layerName);
                }

                args.push(inputFilename);

                log(`Running: tippecanoe ${args.join(' ')}`);

                // Set up progress tracking simulation
                let progress = 20;
                const progressInterval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.random() * 5;
                        progressFill.style.width = `${Math.min(progress, 90)}%`;
                    }
                }, 500);

                // Run tippecanoe
                const startTime = performance.now();
                const result = await tippecanoe.run(
                    args,
                    new Map([[inputFilename, geojsonBytes]]),
                    {
                        onProgress: ({ phase, percent, message }) => {
                            progressText.textContent = `${phase}: ${message}`;
                            if (percent > 0) {
                                progressFill.style.width = `${20 + percent * 0.7}%`;
                            }
                        }
                    }
                );

                clearInterval(progressInterval);
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);

                progressFill.style.width = '100%';
                progressText.textContent = 'Complete!';

                log(`Conversion complete in ${elapsed}s`);
                log(`Output size: ${formatBytes(result.pmtiles.length)}`);

                // Create download blob
                pmtilesBlob = new Blob([result.pmtiles], { type: 'application/octet-stream' });

                // Show success result
                showResult(true, `Conversion successful!`,
                    `Input: ${formatBytes(geojsonBytes.length)} | Output: ${formatBytes(result.pmtiles.length)} | Time: ${elapsed}s`);

            } catch (error) {
                log(`Error: ${error.message}`, true);
                console.error(error);
                showResult(false, 'Conversion failed', error.message);
            }

            convertBtn.disabled = false;
            convertBtn.textContent = 'Convert to PMTiles';
        });

        function showResult(success, title, stats) {
            result.classList.add('active', success ? 'success' : 'error');
            resultTitle.textContent = title;
            resultStats.textContent = stats;
            downloadBtn.style.display = success ? 'inline-block' : 'none';
        }

        // Download
        downloadBtn.addEventListener('click', () => {
            if (!pmtilesBlob) return;

            const filename = selectedFile.name.replace(/\.(geo)?json$/i, '') + '.pmtiles';
            const url = URL.createObjectURL(pmtilesBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
